### Backend Dockerfile
FROM python:3.13-slim

### Prevent Python from writing .pyc files to disc
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1

WORKDIR /app

### Create a non-privileged user
RUN groupadd -g 1000 hevygroup && \
    useradd -u 1000 -g hevygroup -s /bin/sh -m hevyuser

### System dependencies (build-essential for some wheels)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
 && rm -rf /var/lib/apt/lists/*

### Install Python dependencies
COPY backend/requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

### Copy backend sources
COPY backend /app

### Switch to the non-root user
USER hevyuser

EXPOSE 5000

### Run FastAPI with Uvicorn (bind on 0.0.0.0 for container)
CMD ["uvicorn", "fastapi_server:app", "--host", "0.0.0.0", "--port", "5000", "--proxy-headers"]
